<script>
    const NOTIFICACION_OK = 1;
    const NOTIFICACION_DANGER = 2;
    const NOTIFICACION_WARNING = 3;

    //FUNCIONES GUARDAR CONTACTO
    const guardarNuevoContacto = () => {
        let nombre = document.getElementById('formNombre').value;
        let apellido = document.getElementById('formApellido').value;
        let email = document.getElementById('formEmail').value;
        let wpp = document.getElementById('formTelefono').value;

        //Chequeamos que los campos existen
        if(!nombre) {
            crearNotificacion(NOTIFICACION_WARNING, "El campo nombre es necesario", "Atencion!")
            return;
        }

        if(!apellido) {
            crearNotificacion(NOTIFICACION_WARNING, "El campo apellido es necesario", "Atencion!")
            return;
        }

        if(!email) {
            crearNotificacion(NOTIFICACION_WARNING, "El campo email es necesario", "Atencion!")
            return;
        }

        if(document.getElementById('tablaContactos')) document.getElementById('tablaContactos').remove();

        //Cerramos la ventana del modal
        bootstrap.Modal.getInstance(document.getElementById('crearContactoModal')).hide();

        crearLoader('contactosContainer');

        google.script.run
            .withSuccessHandler(guardarNuevoContactoSuccess)
            .withFailureHandler(guardarNuevoContactoError)
            .insertarContacto(nombre, apellido, email, wpp);
    }

    const guardarNuevoContactoSuccess = () => {
        document.getElementById('formNombre').value = '';
        document.getElementById('formApellido').value = '';
        document.getElementById('formEmail').value = '';
        document.getElementById('formTelefono').value = '';

        eliminarLoader();

        mostrarTablaContactos();

        crearNotificacion(NOTIFICACION_OK, "Contacto creado correctamente", "Listo!");
    }

    const guardarNuevoContactoError = () => {
        document.getElementById('formNombre').value = '';
        document.getElementById('formEmail').value = '';

        eliminarLoader();

        crearNotificacion(NOTIFICACION_DANGER, "No se pudo crear el contacto", "Error!")
    }

    //FUNCIONES BORRAR CONTACTO    
    const borrarContacto = (numfila) => {
        if(numfila == 1) {
            crearNotificacion(NOTIFICACION_WARNING, "No existen mas contactos!", "Atencion!");
            return;
        }

        if(document.getElementById('tablaContactos')) document.getElementById('tablaContactos').remove();

        crearLoader('contactosContainer');

        google.script.run
            .withSuccessHandler(borrarContactoSuccess)
            .withFailureHandler(borrarContactoError)
            .BorrarContacto(numfila);
    }

    const borrarContactoSuccess = () => {
        eliminarLoader();

        mostrarTablaContactos();

        crearNotificacion(NOTIFICACION_OK, "Contacto borrado correctamente", "Listo!");
    }

    const borrarContactoError = () => {
        eliminarLoader();

        crearNotificacion(NOTIFICACION_DANGER, "No se pudo borrar el contacto", "Error!")
    }

    //CONSTRUIR Y MOSTRAR TABLA
    const mostrarTablaContactos = () => {
        if(document.getElementById('tablaContactos')) {
            crearNotificacion(NOTIFICACION_WARNING, "La tabla ya se esta mostrando", 'Atencion!')
            return;
        }

        crearLoader('contactosContainer');

        google.script.run
            .withSuccessHandler(obj => construirTablaContactos(obj))
            .withFailureHandler(construirTablaContactosError)
            .obtenerContactos();
    }

    const construirTablaContactos = (obj) => {
        let tabla = document.createElement('table');
        tabla.id = 'tablaContactos';

        let tablaHeader = document.createElement('thead');
        let tablaBody = document.createElement('tbody');

        Array.from(obj).forEach((filaActual, i) => {
            let fila = document.createElement('tr');

            filaActual.forEach(celdaActual => {
                let celda = document.createElement('td');
                celda.textContent = celdaActual;
                fila.appendChild(celda);
            })
            
            //AGREGAMOS BOTONES MODIFICAR Y ELIMINAR
            if(i != 0) {
                let celdaBotones = agregarBotonesModificarBorrar(i + 1);
                fila.appendChild(celdaBotones);
            }

            if(i == 0) {
                let celdaOpciones = document.createElement('td');
                celdaOpciones.classList.add('text-center');
                celdaOpciones.textContent = 'OPCIONES';
                
                fila.appendChild(celdaOpciones);
                
                tablaHeader.appendChild(fila);

                tabla.appendChild(tablaHeader);
            } else {
                tablaBody.appendChild(fila);
            }
            //i == 0? tabla.appendChild(tablaHeader.appendChild(fila)): tablaBody.appendChild(fila); => porque no funciona??
        })

        
        tabla.appendChild(tablaBody);

        tablaHeader.classList.add('table-dark');
        tabla.classList.add('table', 'table-striped', 'border', 'border-3', 'border-dark');

        //Destruimos el loader
        eliminarLoader();

        document.getElementById("contactosContainer").appendChild(tabla);

        //Mostramos la notificacion de exito
        crearNotificacion(NOTIFICACION_OK, 'Contactos obtenidos correctamente', 'Todo en orden');
    }

    const agregarBotonesModificarBorrar = (numfila) => {
        let celda = document.createElement('td');
        celda.classList.add('text-center');

        //Crear boton modificar
        let botonModificar = document.createElement('button');
        //botonBorrar.onclick = () => borrarContacto(numfila);
        botonModificar.classList.add('btn', 'btn-warning', 'm-1');
        
        let iconoModificar = document.createElement('i');
        iconoModificar.classList.add('bi', 'bi-pencil-square');

        botonModificar.appendChild(iconoModificar);
        
        //Crear boton borrar
        let botonBorrar = document.createElement('button');
        botonBorrar.onclick = () => borrarContacto(numfila);
        botonBorrar.classList.add('btn', 'btn-danger', 'm-1');
        
        let iconoBorrar = document.createElement('i');
        iconoBorrar.classList.add('bi', 'bi-trash');

        botonBorrar.appendChild(iconoBorrar);

        //Agregamos los botones a la celda
        celda.appendChild(botonModificar);
        celda.appendChild(botonBorrar);

        return celda;
    }

    const construirTablaContactosError = () => {
        //Eliminamos el loader
        eliminarLoader();

        //Creamos una notificacion advirtiendo del error
        crearNotificacion(NOTIFICACION_DANGER, "Hubo un problema obteniendo los contactos", "Error!");
    }

    const crearNotificacion = (tipo, mensaje, titulo) => {
        //OBTENEMOS LOS DATOS
        let mensajeNotificacion = document.getElementById('notificacionMensaje');
        let tituloNotificacion = document.getElementById('notificacionTitulo');
        let iconoNotificacion = document.getElementById('notificacionIcono');
        
        //Obtenemos el elemento contenedor de la notificacion
        let notificacionElemento = document.getElementById('notificacion');

        //Instanciamos la notificacion
        let notificacion = bootstrap.Toast.getOrCreateInstance(notificacionElemento);

        //EDITAMOS LA NOTIFICACION
        mensajeNotificacion.textContent = mensaje;
        tituloNotificacion.textContent = titulo;
        
        if(tipo == NOTIFICACION_OK) {
            iconoNotificacion.className = '';
            iconoNotificacion.classList.add('bi', 'bi-check-circle');
            notificacionElemento.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-verde-oscuro');
        }

        if(tipo == NOTIFICACION_WARNING) {
            iconoNotificacion.className = '';
            iconoNotificacion.classList.add('bi', 'bi-question-circle');
            notificacionElemento.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-amarillo-oscuro');
        }

        if(tipo == NOTIFICACION_DANGER) {
            iconoNotificacion.className = '';
            iconoNotificacion.classList.add('bi', 'bi-exclamation-circle');
            notificacionElemento.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-rojo-oscuro');
        }

        //MOSTRAMOS LA NOTIFICACION
        notificacion.show();
    }

    const crearLoader = (elementoPadre) => {
        if(document.getElementById('loader')) return;

        let loader = document.createElement('div');
        loader.id = 'loader';

        loader.appendChild(document.createElement('div'));
        loader.appendChild(document.createElement('div'));
        loader.appendChild(document.createElement('div'));
        loader.appendChild(document.createElement('div'));

        loader.classList.add('lds-ellipsis');

        document.getElementById(elementoPadre).appendChild(loader);
    }

    const eliminarLoader = () => {
        let loader = document.getElementById('loader');
        
        if(loader) {
            loader.remove();
        }

        return;
    }

</script>